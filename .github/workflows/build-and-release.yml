name: Build and Release Python QuickStart Course

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.6, 3.7, 3.8, 3.9, '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Test installation
      run: |
        python setup.py install
        python -c "import quick_start; print('Import successful')"
    
    - name: Test quick start script
      run: |
        python quick_start.py --help || echo "Script runs (no --help flag implemented)"

  build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine build
    
    - name: Build source distribution
      run: python -m build --sdist
    
    - name: Build wheel distribution
      run: python -m build --wheel
    
    - name: Check distributions
      run: twine check dist/*
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: python-packages
        path: dist/

  create-release-package:
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: python-packages
        path: dist/
    
    - name: Create release package
      run: |
        # Create a complete package with all files
        mkdir -p release-package
        cp -r . release-package/python-quickstart-course
        cd release-package
        
        # Remove git and build artifacts
        rm -rf python-quickstart-course/.git
        rm -rf python-quickstart-course/.github
        rm -rf python-quickstart-course/dist
        rm -rf python-quickstart-course/build
        rm -rf python-quickstart-course/*.egg-info
        
        # Create installation script
        cat > install.sh << 'EOF'
        #!/bin/bash
        echo "Installing Python QuickStart Course..."
        cd python-quickstart-course
        python -m pip install --upgrade pip
        python -m pip install .
        echo "Installation complete!"
        echo "Run 'python quick_start.py' to start learning Python!"
        EOF
        chmod +x install.sh
        
        # Create Windows installation script
        cat > install.bat << 'EOF'
        @echo off
        echo Installing Python QuickStart Course...
        cd python-quickstart-course
        python -m pip install --upgrade pip
        python -m pip install .
        echo Installation complete!
        echo Run 'python quick_start.py' to start learning Python!
        pause
        EOF
        
        # Create README for the package
        cat > README.txt << 'EOF'
        Python QuickStart Course - Complete Package
        ==========================================
        
        This package contains everything you need to learn Python quickly and easily!
        
        QUICK START:
        -----------
        1. Extract this package to any folder
        2. Run the installation script:
           - On Linux/Mac: ./install.sh
           - On Windows: install.bat
        3. Start learning: python quick_start.py
        
        MANUAL INSTALLATION:
        -------------------
        1. Navigate to the python-quickstart-course folder
        2. Run: python -m pip install .
        3. Start learning: python quick_start.py
        
        WHAT'S INCLUDED:
        ---------------
        - Interactive Python learning system
        - Step-by-step lessons with hands-on activities
        - Calculator building project
        - Python cheatsheet and resources
        - Complete course materials
        
        REQUIREMENTS:
        ------------
        - Python 3.6 or higher
        - No additional dependencies required
        
        SUPPORT:
        -------
        Visit: https://github.com/wiradjuri/python-quickstart-course
        
        Happy coding! 🐍✨
        EOF
        
        # Create the final package
        tar -czf python-quickstart-course-complete.tar.gz *
        zip -r python-quickstart-course-complete.zip *
    
    - name: Upload release packages
      uses: actions/upload-artifact@v3
      with:
        name: release-packages
        path: release-package/*.tar.gz
    
    - name: Upload release packages (ZIP)
      uses: actions/upload-artifact@v3
      with:
        name: release-packages-zip
        path: release-package/*.zip

  publish-to-pypi:
    needs: [test, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: python-packages
        path: dist/
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}

  create-github-release:
    needs: [test, build, create-release-package]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download release packages
      uses: actions/download-artifact@v3
      with:
        name: release-packages
        path: ./
    
    - name: Download release packages (ZIP)
      uses: actions/download-artifact@v3
      with:
        name: release-packages-zip
        path: ./
    
    - name: Download Python packages
      uses: actions/download-artifact@v3
      with:
        name: python-packages
        path: dist/
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          python-quickstart-course-complete.tar.gz
          python-quickstart-course-complete.zip
          dist/*
        body: |
          ## Python QuickStart Course Release
          
          Learn Python the fastest and easiest way possible!
          
          ### 📦 Download Options:
          
          **Complete Package (Recommended):**
          - `python-quickstart-course-complete.zip` - Complete course with installation scripts
          - `python-quickstart-course-complete.tar.gz` - Complete course (Linux/Mac)
          
          **Python Package:**
          - Install via pip: `pip install python-quickstart-course`
          - Or download the wheel/source files below
          
          ### 🚀 Quick Start:
          1. Download the complete package
          2. Extract and run the installation script
          3. Start learning: `python quick_start.py`
          
          ### ✨ Features:
          - Interactive Python learning experience
          - Step-by-step lessons with hands-on activities
          - Build real projects (calculator and more)
          - Complete beginner to functional programmer
          - No external dependencies required
          
          Happy coding! 🐍✨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
